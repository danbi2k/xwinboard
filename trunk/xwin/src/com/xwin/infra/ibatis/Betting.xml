<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE sqlMap
	PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
	"http://ibatis.apache.org/dtd/sql-map-2.dtd">
	
<sqlMap namespace="Betting">

	<typeAlias alias="Betting" type="com.xwin.domain.game.Betting" />
	
	<resultMap id="bettingResultMap" class="Betting">
		<result property="id" column="ID"/>
		<result property="userId" column="USERID"/>
		<result property="date" column="DATE"/>
		<result property="rate" column="RATE"/>
		<result property="money" column="MONEY"/>
		<result property="expect" column="EXPECT"/>
		<result property="status" column="STATUS"/>
		<result property="gameCount" column="GAME_COUNT"/>
		<result property="endCount" column="END_COUNT"/>
		<result property="betGameList" column="ID" select="selectBetGameList"/>
	</resultMap>
	
	<insert id="insertBetting" parameterClass="Betting">
		INSERT INTO tbl_betting(USERID, DATE, RATE, MONEY, EXPECT, STATUS)
			VALUES(#userId#, #date#, #rate#, #money#, #expect#, #status#)
		<selectKey keyProperty="id" resultClass="string">
			SELECT LAST_INSERT_ID()
		</selectKey>			
	</insert>
	
	<delete id="deleteBetting" parameterClass="string">
		DELETE FROM tbl_betting WHERE ID = #value#
	</delete>
	
	<select id="selectBetting" resultMap="bettingResultMap"
		parameterClass="string">
		SELECT *,
		(SELECT COUNT(*) FROM tbl_betting_game g WHERE b.ID = g.BETTING_ID) as GAME_COUNT,
		(SELECT COUNT(*) FROM tbl_betting_game g, tbl_game gg WHERE b.ID = g.BETTING_ID AND GG.ID = g.GAME_ID AND gg.STATUS = 'GS004') as END_COUNT
		FROM tbl_betting b
		WHERE ID = #value#
	</select>
	
	<select id="selectBettingListByUserId" resultMap="bettingResultMap"
		parameterClass="map">
		SELECT *,
		(SELECT COUNT(*) FROM tbl_betting_game g WHERE b.ID = g.BETTING_ID) as GAME_COUNT,
		(SELECT COUNT(*) FROM tbl_betting_game g, tbl_game gg WHERE b.ID = g.BETTING_ID AND GG.ID = g.GAME_ID AND gg.STATUS = 'GS004') as END_COUNT
		FROM tbl_betting b
		WHERE USERID = #userId#
		LIMIT #pageIndex#, #pageSize#
	</select>
	
	<select id="selectBettingList" resultMap="bettingResultMap"
		parameterClass="map">
		SELECT *,
		(SELECT COUNT(*) FROM tbl_betting_game g WHERE b.ID = g.BETTING_ID) as GAME_COUNT,
		(SELECT COUNT(*) FROM tbl_betting_game g, tbl_game gg WHERE b.ID = g.BETTING_ID AND GG.ID = g.GAME_ID AND gg.STATUS = 'GS004') as END_COUNT
		FROM tbl_betting b
	</select>
</sqlMap>
