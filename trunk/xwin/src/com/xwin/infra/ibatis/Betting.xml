<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE sqlMap
	PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
	"http://ibatis.apache.org/dtd/sql-map-2.dtd">
	
<sqlMap namespace="Betting">

	<typeAlias alias="Betting" type="com.xwin.domain.game.Betting" />
	
	<resultMap id="bettingResultMap" class="Betting">
		<result property="id" column="ID"/>
		<result property="userId" column="USERID"/>
		<result property="nickName" column="NICKNAME"/>
		<result property="date" column="DATE"/>
		<result property="rate" column="RATE"/>
		<result property="money" column="MONEY"/>
		<result property="expect" column="EXPECT"/>
		<result property="status" column="STATUS"/>
		<result property="gameType" column="GAME_TYPE"/>
		<result property="totalCount" column="TOTAL_COUNT"/>
		<result property="successCount" column="SUCCESS_COUNT"/>
		<result property="failureCount" column="FAILURE_COUNT"/>
		<result property="betGameList" column="ID" select="selectBetGameList"/>
	</resultMap>
	
	<insert id="insertBetting" parameterClass="Betting">
		INSERT INTO tbl_betting(USERID, NICKNAME, DATE, RATE, MONEY, EXPECT, STATUS, GAME_TYPE, TOTAL_COUNT)
			VALUES(#userId#, #nickName#, #date#, #rate#, #money#, #expect#, #status#, #gameType#, #totalCount#)
		<selectKey keyProperty="id" resultClass="string">
			SELECT LAST_INSERT_ID()
		</selectKey>			
	</insert>
	
	<update id="updateBetting" parameterClass="Betting">
		UPDATE tbl_betting b
		<dynamic prepend="SET">
			<isNotNull prepend="," property="rate">
			RATE = #rate#
			</isNotNull>
			<isNotNull prepend="," property="expect">
			EXPECT = #expect#
			</isNotNull>
			<isNotNull prepend="," property="status">
			STATUS = #status#
			</isNotNull>
		</dynamic>
		WHERE ID = #id#
	</update>
	
	<update id="updateGameCountSuccess" parameterClass="string">
		UPDATE tbl_betting b SET SUCCESS_COUNT =
		(
		SELECT COUNT(*)
		FROM tbl_betting_game bg, tbl_game g
		WHERE
		bg.GAME_ID = g.ID AND
		bg.GUESS = g.RESULT AND
		bg.BETTING_ID = b.ID AND
		g.STATUS = 'GS004'
		)
		WHERE b.ID in (SELECT BETTING_ID FROM tbl_betting_game bg2 WHERE bg2.GAME_ID = #value#)
	</update>
	
	<update id="updateGameCountFailure" parameterClass="string">
		UPDATE tbl_betting b SET FAILURE_COUNT =
		(
		SELECT COUNT(*)
		FROM tbl_betting_game bg, tbl_game g
		WHERE
		bg.GAME_ID = g.ID AND
		((bg.GUESS != g.RESULT AND g.TYPE='wdl') OR (bg.GUESS != g.RESULT AND g.RESULT != 'D' AND g.TYPE='handy')) AND
		bg.BETTING_ID = b.ID AND
		g.STATUS = 'GS004'
		)
		WHERE b.ID in (SELECT BETTING_ID FROM tbl_betting_game bg2 WHERE bg2.GAME_ID = #value#)
	</update>
	
	<update id="updateGameCountHandyDraw" parameterClass="string">
		UPDATE tbl_betting b SET HANDYDRAW_COUNT =
		(
		SELECT COUNT(*)
		FROM tbl_betting_game bg, tbl_game g
		WHERE
		bg.GAME_ID = g.ID AND
		(bg.GUESS != g.RESULT AND g.RESULT = 'D' AND g.TYPE='handy') AND
		bg.BETTING_ID = b.ID AND
		g.STATUS = 'GS004'
		)
		WHERE b.ID in (SELECT BETTING_ID FROM tbl_betting_game bg2 WHERE bg2.GAME_ID = #value#)
	</update>
	
	<update id="updateGameCountCancel" parameterClass="string">
		UPDATE tbl_betting b SET CANCEL_COUNT =
		(
		SELECT COUNT(*)
		FROM tbl_betting_game bg, tbl_game g
		WHERE
		bg.GAME_ID = g.ID AND
		bg.BETTING_ID = b.ID AND
		g.STATUS = 'GS005'
		)
		WHERE b.ID in (SELECT BETTING_ID FROM tbl_betting_game bg2 WHERE bg2.GAME_ID = #value#);
	</update>
	
	<update id="updateBettingStatusByCount">
		UPDATE tbl_betting SET STATUS =
		(CASE
		WHEN FAILURE_COUNT > 0 THEN 'BS003'
		WHEN TOTAL_COUNT = CANCEL_COUNT THEN 'BS005'
		WHEN TOTAL_COUNT = (SUCCESS_COUNT + CANCEL_COUNT) THEN 'BS002'
		WHEN TOTAL_COUNT = HANDYDRAW_COUNT THEN 'BS007'
		ELSE 'BS001'
		END)
		WHERE STATUS != 'BS004' AND STATUS != 'BS006'
	</update>
	
	<delete id="deleteBetting" parameterClass="string">
		DELETE FROM tbl_betting WHERE ID = #value#
	</delete>
	
	<select id="selectBettingList" resultMap="bettingResultMap"
		parameterClass="map">
		SELECT b.*
		FROM tbl_betting b
		<dynamic prepend="WHERE">
			<isNotNull prepend="AND" property="id">
			ID = #id#
			</isNotNull>
			<isNotNull prepend="AND" property="status">
			STATUS = #status#
			</isNotNull>
			<isNotNull prepend="AND" property="gameType">
			GAME_TYPE = #gameType#
			</isNotNull>
			<isNotNull prepend="AND" property="userId">
			USERID = #userId#
			</isNotNull>
			<isNotNull prepend="AND" property="userIdLike">
			USERID LIKE #userIdLike#
			</isNotNull>
			<isNotNull prepend="AND" property="nickNameLike">
			NICKNAME LIKE #nickNameLike#
			</isNotNull>
			<isNotNull prepend="AND" property="fromDate">
			<![CDATA[
			DATE >= #fromDate#
			]]>
			</isNotNull>
			<isNotNull prepend="AND" property="toDate">
			<![CDATA[
			DATE <= #toDate#
			]]>
			</isNotNull>
			<isNotNull prepend="AND" property="gameId">
			b.ID in (SELECT bg.BETTING_ID FROM tbl_betting_game bg WHERE bg.GAME_ID = #gameId#)
			</isNotNull>
		</dynamic>
		ORDER BY DATE DESC
		<isNotNull prepend="LIMIT" property="fromRow">
			#fromRow#, #rowSize#
		</isNotNull>
	</select>
	
	<select id="selectBettingCount" resultClass="integer"
		parameterClass="map">
		SELECT COUNT(*)
		FROM tbl_betting b
		<dynamic prepend="WHERE">
			<isNotNull prepend="AND" property="bettingId">
			ID = #id#
			</isNotNull>
			<isNotNull prepend="AND" property="status">
			STATUS = #status#
			</isNotNull>
			<isNotNull prepend="AND" property="gameType">
			GAME_TYPE = #gameType#
			</isNotNull>
			<isNotNull prepend="AND" property="userId">
			USERID = #userId#
			</isNotNull>
			<isNotNull prepend="AND" property="userIdLike">
			USERID LIKE #userIdLike#
			</isNotNull>
			<isNotNull prepend="AND" property="nickNameLike">
			NICKNAME LIKE #nickNameLike#
			</isNotNull>
			<isNotNull prepend="AND" property="fromDate">
			<![CDATA[
			DATE >= #fromDate#
			]]>
			</isNotNull>
			<isNotNull prepend="AND" property="toDate">
			<![CDATA[
			DATE <= #toDate#
			]]>
			</isNotNull>
			<isNotNull prepend="AND" property="gameId">
			b.ID in (SELECT bg.BETTING_ID FROM tbl_betting_game bg WHERE bg.GAME_ID = #gameId#)
			</isNotNull>
		</dynamic>
	</select>
</sqlMap>